# OAuth Vulnerabilities

- OAuth là một giao thức ủy quyền phổ biến giúp người dùng đăng nhập vào các dịch vụ mà không cần nhập lại mật khẩu.

## Các khái niệm

- Resource Owner: Chủ sở hữu tài nguyên là người hoặc hệ thống kiểm soát dữ liệu nhất định và có thể ủy quyền cho ứng dụng truy cập dữ liệu đó thay mặt họ.

- Client: Máy khách có thể là  ứng dụng di động  hoặc  ứng dụng web phía máy chủ .  Nó hoạt động như một trung gian, yêu cầu truy cập vào tài nguyên và thực hiện các hành động theo sự cho phép của chủ sở hữu tài nguyên.

- Authorization Server: Máy chủ ủy quyền chịu trách nhiệm cấp mã thông báo truy cập cho máy khách sau khi xác thực thành công chủ sở hữu tài nguyên và nhận được ủy quyền của họ. Máy chủ ủy quyền đóng vai trò quan trọng trong quy trình OAuth bằng cách đảm bảo máy khách chỉ được cấp quyền sau khi xác thực và đồng ý hợp lệ của người dùng.

- Resource Server: Máy chủ lưu trữ các tài nguyên được bảo vệ có thể  chấp nhận và phản hồi  các yêu cầu về tài nguyên được bảo vệ bằng cách sử dụng mã thông báo truy cập. Máy chủ này đảm bảo rằng chỉ những máy khách được xác thực và ủy quyền mới có thể truy cập hoặc thao tác dữ liệu của chủ sở hữu tài nguyên.

- Authorization Grant: Máy khách sử dụng thông tin xác thực đại diện cho quyền của chủ sở hữu tài nguyên (để truy cập vào tài nguyên được bảo vệ của họ) để lấy mã thông báo truy cập. Các loại cấp quyền chính là  `Authorization Code`,  `Implicit`,  `Resource Owner Password Credentials`, và  `Client Credentials`.

- Access Token: Một thông tin xác thực mà khách hàng có thể sử dụng để truy cập vào các tài nguyên được bảo vệ thay mặt cho chủ sở hữu tài nguyên. Nó có tuổi thọ và phạm vi hạn chế. Mã thông báo truy cập rất cần thiết để duy trì giao tiếp an toàn và được bảo vệ giữa khách hàng và máy chủ tài nguyên mà không cần phải yêu cầu chủ sở hữu tài nguyên cung cấp thông tin xác thực nhiều lần.

- Refresh Token: Một thông tin xác thực mà khách hàng có thể sử dụng để có được mã thông báo truy cập mới mà không yêu cầu chủ sở hữu tài nguyên phải xác thực lại. Mã thông báo làm mới thường tồn tại lâu dài và cung cấp một cách để duy trì các phiên của người dùng mà không bị gián đoạn đăng nhập thường xuyên. 

- Redirect URI: URI mà máy chủ ủy quyền sẽ chuyển hướng tác nhân người dùng của chủ sở hữu tài nguyên sau khi cấp hoặc từ chối ủy quyền. Nó kiểm tra xem máy khách mà phản hồi ủy quyền đã được yêu cầu có đúng không. 

- Scope: Là cơ chế giới hạn quyền truy cập của ứng dụng vào tài khoản của người dùng. Chúng cho phép máy khách chỉ định mức truy cập cần thiết và máy chủ cấp phép thông báo cho người dùng mức truy cập nào mà ứng dụng đang yêu cầu. Phạm vi giúp thực thi `principle of least privilege`. 

- State Parameter: Một tham số tùy chọn duy trì trạng thái giữa máy khách và máy chủ ủy quyền. Nó có thể giúp ngăn chặn các cuộc tấn công CSRF bằng cách đảm bảo phản hồi khớp với yêu cầu của máy khách. Tham số state là một phần quan trọng trong việc bảo mật luồng OAuth.

- Token & Authorization Endpoint: Là nơi máy khách trao đổi quyền cấp phép (hoặc mã thông báo làm mới) để lấy mã thông báo truy cập. Ngược lại, điểm cuối ủy quyền là nơi chủ sở hữu tài nguyên được xác thực và ủy quyền cho máy khách truy cập vào các tài nguyên được bảo vệ.


## Các loại cấp quyền OAuth

- ***Authorization Code Grant*** là luồng OAuth 2.0 được sử dụng phổ biến nhất phù hợp với các ứng dụng phía máy chủ ( PHP , JAVA, .NET, v.v.). Trong luồng này, máy khách chuyển hướng người dùng đến máy chủ ủy quyền, nơi người dùng xác thực và cấp quyền . Sau đó, máy chủ ủy quyền chuyển hướng người dùng đến máy khách có mã ủy quyền . Máy khách trao đổi mã ủy quyền để lấy mã thông báo truy cập bằng cách yêu cầu điểm cuối mã thông báo của máy chủ ủy quyền.

![image](https://github.com/user-attachments/assets/5d07865c-2f99-46df-a6e8-a12dca3f0c94)

  - Loại cấp phép này được biết đến với tính bảo mật nâng cao, vì mã ủy quyền được trao đổi để lấy mã thông báo truy cập từ máy chủ đến máy chủ, nghĩa là mã thông báo truy cập không bị lộ cho tác nhân người dùng (ví dụ: trình duyệt), do đó giảm nguy cơ rò rỉ mã thông báo. Nó cũng hỗ trợ sử dụng mã thông báo làm mới để duy trì quyền truy cập lâu dài mà không cần xác thực người dùng nhiều lần.

- ***Implicit Grant*** Quyền cấp phép ngầm định chủ yếu được thiết kế cho các ứng dụng di động và web, nơi mà khách hàng không thể lưu trữ bí mật một cách an toàn. Quyền này cấp trực tiếp mã thông báo truy cập cho khách hàng mà không yêu cầu trao đổi mã ủy quyền . Trong luồng này, khách hàng chuyển hướng người dùng đến máy chủ ủy quyền. Sau khi người dùng xác thực và cấp quyền, máy chủ ủy quyền trả về mã thông báo truy cập trong đoạn URL . Luồng hoàn chỉnh được hiển thị bên dưới:

![image](https://github.com/user-attachments/assets/a4b69f37-4064-43ad-b7d5-cfc483052ba4)


- ***Resource Owner Password Credentials Grant*** được sử dụng khi máy khách được chủ sở hữu tài nguyên tin tưởng cao , chẳng hạn như các ứng dụng của bên thứ nhất. Máy khách thu thập thông tin xác thực của người dùng (tên người dùng và mật khẩu) trực tiếp và trao đổi chúng để lấy mã thông báo truy cập, như được hiển thị bên dưới:

![image](https://github.com/user-attachments/assets/8072757a-d9f5-4e4f-afee-50ddb1a00ec6)

- ***Client Credentials Grant*** được sử dụng cho các tương tác giữa máy chủ với máy chủ mà không cần sự tham gia của người dùng. Máy khách sử dụng thông tin xác thực của mình để xác thực với máy chủ ủy quyền và lấy mã thông báo truy cập. Trong luồng này, máy khách xác thực với máy chủ ủy quyền bằng thông tin xác thực của máy khách (ID máy khách và bí mật) và máy chủ ủy quyền cấp mã thông báo truy cập trực tiếp cho máy khách, như được hiển thị bên dưới:

![image](https://github.com/user-attachments/assets/119628e6-4510-4f4f-82cc-8dbce83a693c)

## OAuth Flow 

![image](https://github.com/user-attachments/assets/e4c5be87-ca1c-49ea-b950-aec1bd1f3252)

## Khai thác OAuth - Đánh cắp mã thông báo OAuth

-  Kẻ tấn công có thể gửi cho nạn nhân liên kết ( http ://dev.bistro. thm :8002/redirect_uri.html ) thông qua các chiến thuật kỹ thuật xã hội hoặc một cuộc tấn công CSRF.

![image](https://github.com/user-attachments/assets/be2c3ae8-b928-487a-9395-0b8f8059f77f)

- Nạn nhân click vào Login via OAuth biểu mẫu sẽ gọi đến http://coffee.thm:8000/oauthdemo/oauth_login/ nhưng với một redirect_uri khác

![image](https://github.com/user-attachments/assets/6ae3fba9-a2ae-4caf-bdbb-e3a29d003cd8)

- Kẻ tấn công có được auth_code và lấy nó để truy cập trái phép:

![image](https://github.com/user-attachments/assets/02509ea8-3b79-4a5f-8821-2d31b63ea8e2)

## Khai thác OAuth - CSRF trong OAuth

- Tham số state trong khuôn khổ OAuth 2.0 bảo vệ chống lại các cuộc tấn công CSRF , xảy ra khi kẻ tấn công lừa người dùng thực hiện các hành động không mong muốn trên ứng dụng web nơi họ hiện đang được xác thực. Trong bối cảnh của OAuth, các cuộc tấn công CSRF có thể dẫn đến truy cập trái phép vào các tài nguyên nhạy cảm bằng cách chiếm đoạt luồng OAuth. Tham số trạng thái giúp giảm thiểu rủi ro này bằng cách duy trì tính toàn vẹn của quy trình ủy quyền.

- Tham số state là chuỗi tùy ý có trong yêu cầu xác nhận ủy quyền, và khi máy chủ ủy quyền phản hôi lại sẽ kèm theo tham số này, ứng dụng phía client sẽ xác minh xem tham số phản hồi lại có khớp với ban đầu không ==> đảm bảo hạn chế cuộc tấn công CSRF

- Nếu không có state tham số, quy trình ủy quyền sẽ dễ bị CSRF . Kẻ tấn công có thể khai thác lỗ hổng này bằng cách lấy mã ủy quyền của nạn nhân và gửi cho kẻ tấn công. Máy chủ ủy quyền sẽ không có cách nào để xác định mã ủy quyền thuộc về kẻ tấn công hay nạn nhân hoặc yêu cầu đến từ kẻ tấn công hay nạn nhân.

### Lỗ hổng của tham số trạng thái yếu hoặc thiếu

- Tham số state là một chuỗi tùy ý mà ứng dụng khách hàng bao gồm trong yêu cầu ủy quyền. Khi máy chủ ủy quyền chuyển hướng người dùng trở lại ứng dụng khách hàng với mã ủy quyền, nó cũng bao gồm tham số trạng thái. Sau đó, ứng dụng khách hàng xác minh rằng tham số trạng thái trong phản hồi khớp với tham số mà nó đã gửi ban đầu. Xác thực này đảm bảo rằng phản hồi không phải là kết quả của cuộc tấn công CSRF mà là sự tiếp tục hợp pháp của luồng OAuth.

- Điểm yếu

  - Tiết lộ Mã thông báo truy cập trong URL :  Ứng dụng chuyển hướng người dùng đến điểm cuối xác thực OAuth, trả về mã thông báo truy cập trong đoạn URL. Bất kỳ tập lệnh nào đang chạy trên trang đều có thể dễ dàng truy cập đoạn này.
    
  - Xác thực không đầy đủ URI chuyển hướng :  Máy chủ OAuth không xác thực đầy đủ URI chuyển hướng, cho phép kẻ tấn công tiềm năng thao túng điểm cuối chuyển hướng.
    
  - Không triển khai HTTPS : Ứng dụng không triển khai HTTPS, điều này có thể dẫn đến việc chặn mã thông báo thông qua các cuộc tấn công trung gian.
  
  - Xử lý mã thông báo truy cập không đúng cách :  Ứng dụng lưu trữ mã thông báo truy cập không an toàn, có thể ở định dạng localStorage.exe hoặc sessionStorage.exe , khiến ứng dụng dễ bị tấn công XSS.























