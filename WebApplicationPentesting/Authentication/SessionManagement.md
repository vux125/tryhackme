# Session Management

## Bảo mật vòng đời của phiên

![image](https://github.com/user-attachments/assets/b6234cd9-4ef2-499e-8134-d1cea69717fe)

- Hãy cùng xem xét những gì có thể xảy ra sai sót ở từng giai đoạn.

### Session Creation

- Việc tạo phiên là nơi dễ xảy ra nhiều lỗ hổng nhất. Chúng ta hãy cùng tìm hiểu một số lỗ hổng phổ biến.

- **Weak Session Values:** Nếu một cơ chế tạo phiên tùy chỉnh đã được triển khai, có khả năng cao là các giá trị phiên có thể đoán được. Một ví dụ điển hình về điều này là cơ chế chỉ mã hóa base64 tên người dùng thành giá trị phiên. Nếu một tác nhân đe dọa có thể đảo ngược quá trình tạo phiên, chúng có thể tạo hoặc đoán các giá trị phiên để chiếm đoạt tài khoản của người dùng hợp pháp.

- **Controllable Session Values:** Trong một số mã thông báo, chẳng hạn như JWT, tất cả thông tin có liên quan để tạo và xác minh tính hợp lệ của JWT đều được cung cấp. Nếu các biện pháp bảo mật không được thực thi, chẳng hạn như xác minh chữ ký của mã thông báo hoặc đảm bảo rằng chữ ký đó được tạo ra một cách an toàn, thì tác nhân đe dọa sẽ có thể tạo mã thông báo của riêng chúng.

- **Session Fixation:** Bạn còn nhớ ứng dụng web đã cung cấp cho bạn một phiên trước khi xác thực không? Các ứng dụng web này có thể dễ bị tấn công bởi một thứ gọi là cố định phiên. Nếu giá trị phiên của bạn không được xoay vòng đầy đủ sau khi bạn xác thực, một tác nhân đe dọa ở vị trí phù hợp có thể ghi lại giá trị đó khi bạn vẫn chưa xác thực và chờ bạn xác thực để có quyền truy cập vào phiên của bạn. 

- **Insecure Session Transmission:** Trong môi trường hiện đại, máy chủ xác thực và máy chủ ứng dụng thường tách biệt. Hãy nghĩ về những thứ như giải pháp Đăng nhập một lần ( SSO ). Một ứng dụng được sử dụng để xác thực cho một số ứng dụng web khác. Để quy trình này hoạt động, tài liệu phiên của bạn phải được chuyển từ máy chủ xác thực sang máy chủ ứng dụng thông qua trình duyệt của bạn. Tuy nhiên, trong quá trình truyền này, một số vấn đề nhất định có thể xảy ra khiến thông tin phiên của bạn bị tiết lộ cho tác nhân đe dọa. Phổ biến nhất là chuyển hướng không an toàn, trong đó tác nhân đe dọa có thể kiểm soát URL mà bạn sẽ được chuyển hướng đến sau khi xác thực. Điều này có thể cho phép tác nhân đe dọa chiếm đoạt phiên của bạn.

### Session Tracking

- Theo dõi phiên là thủ phạm lớn thứ hai gây ra lỗ hổng. Chúng ta hãy cùng xem xét.

- **Authorisation Bypass**: Bỏ qua ủy quyền xảy ra khi không có đủ các kiểm tra được thực hiện để xác định xem người dùng có được phép thực hiện hành động mà họ yêu cầu hay không. Về bản chất, điều này không theo dõi đúng phiên của người dùng và các quyền liên quan của người dùng.

- **Insufficient Logging**: Một vấn đề chính trong các sự cố là không có đủ thông tin để ghép lại thành một cuộc tấn công. Trong khi nhiều hoạt động ghi nhật ký sẽ diễn ra ở cấp độ cơ sở hạ tầng, hoạt động ghi nhật ký ứng dụng có thể rất quan trọng để hiểu được điều gì đã xảy ra sai.

### Session Expiry

- Phiên hết hạn chỉ có một lỗ hổng duy nhất, đó là khi thời gian hết hạn cho các phiên quá dài.

### Session Termination

- Đối với việc chấm dứt phiên, vấn đề chính là khi các phiên không được chấm dứt đúng cách ở phía máy chủ khi hành động đăng xuất được thực hiện

## Exploting Insecure Session Management

- Truy cập trang http://10.10.244.86/auth/login

![image](https://github.com/user-attachments/assets/5863020f-b59b-4fd3-a50c-909cb838458d)

- Ta thấy rằng cookie không được thiết lập điều này có thể chứng tỏ các phiên chưa xác thực rất có thể không được theo dõi

- Ta thực hiện đăng ký với tư cách Student và thực hiện đăng nhập, quan sát lưu lượng mạng:

![image](https://github.com/user-attachments/assets/4feb00cc-6d8a-4fa7-ac65-dd7c134fabbd)

- Ta thu được các thông tin:

  - Cookie được sử dụng để quản lý phiên
 
  - HTTPOnly được thiết lập để không sử dụng JS đọc giá trị Cookie
 
  - Thời gian hết hạn của Cookie khá đáng ngờ vì nó bằng thời gian được tạo.

- Khi thực hiện các yêu cầu thì cookie được gửi kèm theo request

- 
